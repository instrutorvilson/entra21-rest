<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body class="container">
    <h1 class="text-center">Agenda</h1>
    <button onclick="salvar()">salvar</button>
    <button onclick="consultarById(1)">Consulta 1</button>
    <button onclick="alterar(5)">Alterar</button>
    <Button onclick="logar()">Login</Button>
    <Button onclick="consultarContatos()">Contatos</Button>
    <div  class="col d-flex justify-content-between" >        
        <div id="login" class="col-md-3 border border-primary mt-3 p-3">
            <h2 class="text-center m-3 b-">fazer login</h2>
           <form>
                <label class="form-label" for="email">Informe email</label>
                <input class="form-control" type="email" id="email" placeholder="Informe email" required/>
                <label class="form-label" for="senha">Informe senha</label>
                <input class="form-control" type="password" id="senha" placeholder="Informe senha" required />
                <div class="mt-3">
                    <button onclick="logar()" class="btn btn-outline-primary">Logar</button>
                    <a class="link-success link-underline-opacity-100-hover link-offset-3" href="#registar" onclick="document.getElementById('registrar').style='display:block'">Registrar</a>
                </div>
           </form>            
        </div>
        <!--Criar formulario de registro de usuário-->
        <div  id="registrar" class="col-md-5 border border-primary mt-3 p-3" style="display: block;">
            <h2 class="text-center m-3 b-">Resgistrar usuário</h2>
           <form>
                <label class="form-label" for="nome">Informe nome</label>
                <input class="form-control" type="text" id="nome" placeholder="Informe nome" required/>
                <label class="form-label" for="user">Informe email</label>
                <input class="form-control" type="email" id="user" placeholder="Informe email" required/>
                <label class="form-label" for="pass">Informe senha</label>
                <input class="form-control" type="password" id="pass" placeholder="Informe senha" required />
                <label class="form-label" for="role">Informe nome</label>
                <select id="role" class="form-control">
                    <option value="authority:ROLE_ADMIN">Administrador</option>
                    <option value="ROLE_USUARIO">Usuário</option>
                    <option value="ROLE_OPERADOR">Operador</option>
                </select>
                <div class="mt-3 d-flex justify-content-between">
                    <button onclick="RegistrarUser()" class="btn btn-outline-primary">Registrar</button>
                    <input class="btn btn-outline-danger" type="reset" />
                </div>
           </form>            
        </div>
    </div>
    <div id="consulta">

    </div>
    <script>     
        function logar(){    
          const headers = new Headers();
          headers.append('Content-Type', 'application/x-www-form-urlencoded');
          headers.append('Authorization', `Basic ${btoa('entra21:entra21-2023')}`); //quando acessa browser usa btoa, em node usa base64
            fetch('http://localhost:8080/oauth/token',
            {
               method: 'POST',
               headers: headers,
            body: new URLSearchParams({
                  'username': document.getElementById('email').value,
                  'password': document.getElementById('senha').value,
                  'grant_type': 'password'
                })
            }) 
            .then(data => data.json())
            .then(response => {
                let jsonToken = JSON.stringify(response)
                sessionStorage.setItem('userLogado', JSON.parse(jsonToken).access_token )
            }) 
            .catch(error => console.error('Error:', error));
        }
               
        function consultar(){
            let token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDMyNDcyNjgsInVzZXJfbmFtZSI6ImZlbGlwZUBnbWFpbC5jb20iLCJhdXRob3JpdGllcyI6WyJST0xFX09QRVJBRE9SIl0sImp0aSI6IjBiNGEyNTU4LWYwZTUtNDAwMC04MThkLWY2ODllZWExYTVkZCIsImNsaWVudF9pZCI6ImVudHJhMjEiLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXX0.z2y_Ahjp6__PqQbEU-SJEzUwKPJVQpPcJgtyGO14KWc'
            fetch('http://localhost:8080/contatos',
            {
               headers:{'Authorization': `Bearer ${token}`}
            })
            .then(data => data.json())
            .then(response => console.log(response))
        }

        function RegistrarUser(){
            let token =  sessionStorage.getItem('userLogado')
            const headers = new Headers();
            headers.append('Authorization',`Bearer ${token}`)
            headers.append('Content-Type', 'application/json')    
                 
            let obj = {
                        nome: document.getElementById('nome').value,
                        email: document.getElementById('user').value,
                        senha: document.getElementById('pass').value,
                        roles: [{id: document.getElementById('role').selectedIndex+1, authority: document.getElementById('role').value}]
                    }
             fetch('http://localhost:8080/usuarios',
                {
                   method: 'POST',
                   body: JSON.stringify(obj),
                   headers: headers
                }
             )
            .then( x => window.location.href = "#consulta" )  
            .catch(error => console.log(error))
        }

        function alterar(id){
            let obj = {
                        id: id,
                        nome: "zezinho da silva",
                        email: "zezinho@gmail.com",
                        fone: "(47)9809-0987"
                    }
             fetch(`http://localhost:8080/contatos/${id}`,
                {
                   method: 'PUT',
                   body: JSON.stringify(obj),
                   headers:{ 'Content-Type': 'application/json' }
                }
             )
            .then(x => alert('inserido'))  
            .catch(error => console.log(error))
        }
        
        function consultarById(id){
            let token =  sessionStorage.getItem('userLogado')
            console.log(token)
            headers.append('Authorization', `Bearer ${token}`)
            fetch(`http://localhost:8080/contatos/${id}`,{
                headers: headers
            })
            .then(data => data.json())
            .then(response => console.log(response))
        }

        function consultarContatos(){
            let token =  sessionStorage.getItem('userLogado') 
            console.log(token)
            fetch('http://localhost:8080/contatos',{
                headers:{'Authorization': `Bearer ${token}`}
            })
            .then(data => data.json())
            .then(response => console.log(response))
            .catch(error => console.log(error))
        }
    </script>
</body>
</html>